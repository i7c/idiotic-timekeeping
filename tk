#!/bin/bash

export time_journal='journal.ldg'

acc_login_string(){
    echo "i $(date +'%Y/%m/%d %H:%M:%S') $*"
}

acc_logout_string() {
    echo "o $(date +'%Y/%m/%d %H:%M:%S') $*"
}

acc_login() {
    acc_login_string "$@" | vipe >> $time_journal
}

acc_logout() {
    acc_logout_string "$@" | vipe >> $time_journal
}

acc_switch_string() {
    acc_logout_string "$1"
    acc_login_string "$2"
}

acc_switch() {
     acc_switch_string "$@" | vipe >> $time_journal
}

silent() {
    "$@" >& /dev/null
}

check() {
    silent "$@" || {
        echo "checked execution failed: $*";
        exit 1;
    }
}

show() {
    ledger bal -f $time_journal
}

check which vipe
check which ledger
if [[ ! $1 ]]; then
    echo "Specify command."
    exit 1;
fi
command=$1
shift

case $command in
    "login"|"li")
        acc_login "$@";
        show
        ;;
    "logout"|"lo")
        acc_logout "$@";
        show
        ;;
    "switch"|"sw")
        acc_switch "$@";
        show
        ;;
    "show")
        show
        ;;
    "commit")
        git add $time_journal
        check git diff --exit-code
        git commit -m "$(date +'%Y/%m/%d %H:%M:%S') Automatic commit"
        ;;
    default)
        echo "Wrong command.";
        exit 1;
esac
exit 0;
